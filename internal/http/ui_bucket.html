<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buck It Up - Bucket View</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(to bottom right, #f0f4f8 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .navbar h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
        .navbar .user-info { display: flex; gap: 15px; align-items: center; font-size: 15px; font-weight: 500; }
        .btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            font-weight: 600;
        }
        .btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:active { transform: translateY(0); }
        .btn:focus { outline: 2px solid white; outline-offset: 2px; }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        .btn-primary:focus { outline: 2px solid #667eea; outline-offset: 2px; }
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }
        .btn-secondary:hover {
            background: #667eea;
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }
        .btn-secondary:focus { outline: 2px solid #667eea; outline-offset: 2px; }
        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            border: none;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(245, 101, 101, 0.3);
        }
        .btn-danger:hover { background: linear-gradient(135deg, #e53e3e 0%, #9b2c2c 100%); box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4); }
        .btn-danger:focus { outline: 2px solid #f56565; outline-offset: 2px; }
        .btn-sm { padding: 7px 14px; font-size: 13px; }
        .btn-copy {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            border: none;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(8, 145, 178, 0.3);
        }
        .btn-copy:hover { background: linear-gradient(135deg, #0e7490 0%, #155e75 100%); box-shadow: 0 4px 12px rgba(8, 145, 178, 0.4); }
        .btn-copy:focus { outline: 2px solid #0891b2; outline-offset: 2px; }
        .container { max-width: 1400px; margin: 40px auto; padding: 0 24px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h2 { color: #1a202c; font-size: 32px; font-weight: 700; }
        .breadcrumb { color: #718096; margin-bottom: 24px; font-size: 15px; }
        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }
        .breadcrumb a:hover { color: #764ba2; text-decoration: underline; }
        .breadcrumb a:focus { outline: 2px solid #667eea; outline-offset: 2px; border-radius: 3px; }
        .objects-table {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        table { width: 100%; border-collapse: collapse; }
        thead { background: linear-gradient(to right, #f7fafc 0%, #edf2f7 100%); }
        th {
            padding: 16px 18px;
            text-align: left;
            font-weight: 700;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td { padding: 16px 18px; border-bottom: 1px solid #f0f4f8; color: #4a5568; }
        tr:hover { background: #f8fafc; transition: background 0.15s; }
        tr:last-child td { border-bottom: none; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-content h3 { color: #1a202c; font-size: 24px; margin-bottom: 24px; font-weight: 700; }
        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: #f7fafc;
            color: #4a5568;
            font-size: 20px;
            line-height: 36px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-close:hover { background: #edf2f7; color: #667eea; transform: rotate(90deg); }
        .modal-close:focus { outline: 2px solid #667eea; outline-offset: 2px; }
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; margin-bottom: 8px; color: #2d3748; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            color: #2d3748;
            transition: all 0.2s;
        }
        .form-group textarea { min-height: 180px; font-family: 'Courier New', monospace; line-height: 1.5; }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 28px; }
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #718096;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }
        .empty-state svg { margin: 0 auto 24px; display: block; }
        .empty-state h3 { font-size: 26px; margin-bottom: 12px; color: #2d3748; font-weight: 700; }
        .empty-state p { font-size: 16px; color: #718096; }
        .empty-state-msg { font-size: 16px; margin-top: 12px; color: #4a5568; font-style: italic; }
        .loading { text-align: center; padding: 60px; color: #718096; font-size: 16px; }
        .size { color: #718096; font-size: 13px; font-weight: 500; }
        .content-preview {
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            max-height: 300px;
            overflow: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid #e2e8f0;
            line-height: 1.6;
        }
        .file-input-wrapper { position: relative; display: inline-block; width: 100%; }
        .file-input-wrapper input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-input-label {
            display: block;
            padding: 32px 20px;
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            color: #718096;
            font-weight: 500;
        }
        .file-input-label:hover { border-color: #667eea; background: #eef2ff; color: #667eea; }
        .file-selected { margin-top: 12px; color: #667eea; font-size: 14px; font-weight: 600; }
        .folder-row td { font-weight: 600; background: #fafbfc; }
        .folder-row:hover td { background: #f0f4f8; }
        .folder-toggle {
            cursor: pointer;
            display: inline-block;
            width: 20px;
            text-align: center;
            user-select: none;
            color: #667eea;
            font-weight: bold;
        }
        .folder-name { color: #2d3748; font-weight: 600; }
        .folder-meta { color: #718096; font-size: 12px; margin-left: 8px; font-weight: 500; }
        .object-name { color: #2d3748; font-weight: 600; }
        .indent { display: inline-block; }
        .access-keys-section {
            background: white;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
        }
        .access-keys-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .access-keys-header h3 { margin: 0; color: #1a202c; font-size: 20px; font-weight: 700; }
        .access-keys-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .access-key-card {
            background: linear-gradient(to bottom right, #f7fafc 0%, #edf2f7 100%);
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .access-key-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .access-key-card h4 {
            margin: 0 0 14px 0;
            color: #667eea;
            font-size: 17px;
            text-transform: capitalize;
            font-weight: 700;
        }
        .access-key-field { margin-bottom: 12px; }
        .access-key-field label { display: block; font-size: 12px; color: #718096; margin-bottom: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .access-key-field .value {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: white;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            word-break: break-all;
            color: #2d3748;
        }
        .access-key-card .actions { margin-top: 16px; }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>ü™£ Buck It Up</h1>
        <div class="user-info">
            <span>Admin</span>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </div>
    <div class="container">
        <div class="breadcrumb"><a href="/ui/dashboard">‚Üê Back to Buckets</a></div>
        <div class="header">
            <h2 id="bucketTitle">Loading...</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="toggleAccessKeys()">üîë Access Keys</button>
                <button class="btn btn-primary" onclick="showUploadModal()">+ Upload Object</button>
            </div>
        </div>
        <div id="accessKeysSection" class="access-keys-section" style="display: none;">
            <div class="access-keys-header">
                <h3>Access Keys</h3>
                <button class="btn btn-sm" onclick="toggleAccessKeys()">Hide</button>
            </div>
            <div id="accessKeysLoading" class="loading" style="padding: 20px;">Loading access keys...</div>
            <div id="accessKeysGrid" class="access-keys-grid" style="display: none;"></div>
        </div>
        <div id="loading" class="loading">Loading objects...</div>
        <div id="objectsTable" class="objects-table" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>Object Key</th>
                        <th>Size</th>
                        <th>Content Type</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="objectsBody"></tbody>
            </table>
        </div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <img src="/ui/empty.svg" alt="Empty bucket illustration" width="220" height="220" id="emptyStateImage">
            <h3>No objects yet</h3>
            <p>Upload your first object to get started</p>
            <div id="emptyMessage" class="empty-state-msg"></div>
        </div>
    </div>
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <button type="button" class="modal-close" aria-label="Close" onclick="hideUploadModal()">√ó</button>
            <h3>Upload Object</h3>
            <form id="uploadForm">
                <div class="form-group">
                    <label for="objectKey">Object Key</label>
                    <input type="text" id="objectKey" name="objectKey" required placeholder="e.g., my-file.txt or folder/file.json">
                </div>
                <div class="form-group">
                    <label for="contentType">Content Type</label>
                    <input type="text" id="contentType" name="contentType" placeholder="e.g., text/plain (auto-detected from file)">
                </div>
                <div class="form-group">
                    <label>Upload Method</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="uploadMethod" value="file" checked onchange="toggleUploadMethod()">
                            File Upload
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="uploadMethod" value="text" onchange="toggleUploadMethod()">
                            Text Content
                        </label>
                    </div>
                </div>
                <div class="form-group" id="fileUploadGroup">
                    <label>Choose File</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="fileInput" onchange="handleFileSelect()">
                        <div class="file-input-label">Click to select a file or drag and drop</div>
                    </div>
                    <div id="fileSelected" class="file-selected"></div>
                </div>
                <div class="form-group" id="textUploadGroup" style="display: none;">
                    <label for="contentText">Text Content</label>
                    <textarea id="contentText" name="contentText" placeholder="Enter text content here..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" onclick="hideUploadModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <button type="button" class="modal-close" aria-label="Close" onclick="hideViewModal()">√ó</button>
            <h3 id="viewObjectKey">Object Details</h3>
            <div class="form-group">
                <label>Content Type</label>
                <div id="viewContentType" style="padding: 10px; background: #f8f9fa; border-radius: 4px;"></div>
            </div>
            <div class="form-group">
                <label>Size</label>
                <div id="viewSize" style="padding: 10px; background: #f8f9fa; border-radius: 4px;"></div>
            </div>
            <div class="form-group">
                <label>Content Preview</label>
                <div id="viewContent" class="content-preview"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="hideViewModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="downloadCurrentObject()">Download</button>
            </div>
        </div>
    </div>
    <div id="recreatedKeyModal" class="modal">
        <div class="modal-content">
            <button type="button" class="modal-close" aria-label="Close" onclick="hideRecreatedKeyModal()">√ó</button>
            <h3>‚ö†Ô∏è New Access Key Created</h3>
            <p style="color: #e74c3c; margin-bottom: 20px; font-weight: 600;">Save these credentials now! The secret will not be shown again.</p>
            <div class="form-group">
                <label>Role</label>
                <div id="recreatedRole" style="padding: 10px; background: #f8f9fa; border-radius: 4px; text-transform: capitalize;"></div>
            </div>
            <div class="form-group">
                <label>Key ID</label>
                <div id="recreatedKeyId" class="content-preview" style="max-height: none;"></div>
            </div>
            <div class="form-group">
                <label>Secret</label>
                <div id="recreatedSecret" class="content-preview" style="max-height: none;"></div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="copyRecreatedKey()">üìã Copy Both</button>
                <button type="button" class="btn" onclick="hideRecreatedKeyModal()">Close</button>
            </div>
        </div>
    </div>
    <script>
        let currentBucket = '';
        let currentViewObject = null;
        let currentRecreatedKey = null;

        function getBucketName() {
            const path = window.location.pathname;
            const match = path.match(/\/ui\/bucket\/([^\/]+)/);
            return match ? decodeURIComponent(match[1]) : null;
        }
        function getAuthHeader() {
            const auth = localStorage.getItem('adminAuth');
            if (!auth) { window.location.href = '/ui/login'; return null; }
            return 'Bearer ' + atob(auth);
        }
        function logout() { localStorage.removeItem('adminAuth'); window.location.href = '/ui/login'; }
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function toggleAccessKeys() {
            const section = document.getElementById('accessKeysSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                await loadAccessKeys();
            } else {
                section.style.display = 'none';
            }
        }

        async function loadAccessKeys() {
            const auth = getAuthHeader();
            if (!auth) return;

            const loading = document.getElementById('accessKeysLoading');
            const grid = document.getElementById('accessKeysGrid');

            loading.style.display = 'block';
            grid.style.display = 'none';

            try {
                const response = await fetch('/' + encodeURIComponent(currentBucket) + '/access-keys', {
                    method: 'GET',
                    headers: { 'Authorization': auth }
                });
                if (response.status === 401) { logout(); return; }
                if (!response.ok) throw new Error('Failed to load access keys');

                const keys = await response.json();
                displayAccessKeys(keys);
            } catch (err) {
                console.error('Error loading access keys:', err);
                loading.textContent = 'Error loading access keys: ' + err.message;
            }
        }

        function displayAccessKeys(keys) {
            const loading = document.getElementById('accessKeysLoading');
            const grid = document.getElementById('accessKeysGrid');

            loading.style.display = 'none';
            grid.style.display = 'grid';

            const roleOrder = { 'readOnly': 1, 'readWrite': 2, 'all': 3 };
            keys.sort((a, b) => roleOrder[a.role] - roleOrder[b.role]);

            grid.innerHTML = keys.map(key => {
                const createdDate = new Date(key.created_at * 1000).toLocaleDateString();
                const roleNames = {
                    'readOnly': 'Read Only',
                    'readWrite': 'Read/Write',
                    'all': 'Full Access (All)'
                };
                return `
                    <div class="access-key-card">
                        <h4>${roleNames[key.role] || key.role}</h4>
                        <div class="access-key-field">
                            <label>Key ID</label>
                            <div class="value">${escapeHtml(key.key_id)}</div>
                        </div>
                        <div class="access-key-field">
                            <label>Created</label>
                            <div class="value">${createdDate}</div>
                        </div>
                        <div class="actions">
                            <button class="btn btn-danger btn-sm" onclick="recreateAccessKey('${key.role}')">üîÑ Recreate</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function recreateAccessKey(role) {
            const roleNames = {
                'readOnly': 'Read Only',
                'readWrite': 'Read/Write',
                'all': 'Full Access (All)'
            };

            if (!confirm(`Are you sure you want to recreate the ${roleNames[role]} access key?\n\nThe old key will stop working immediately!`)) {
                return;
            }

            const auth = getAuthHeader();
            if (!auth) return;

            try {
                const response = await fetch('/' + encodeURIComponent(currentBucket) + '/access-keys/recreate', {
                    method: 'POST',
                    headers: {
                        'Authorization': auth,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: role })
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || 'Failed to recreate access key');
                }

                const newKey = await response.json();
                currentRecreatedKey = newKey;

                // Show the new key with secret
                document.getElementById('recreatedRole').textContent = roleNames[newKey.role] || newKey.role;
                document.getElementById('recreatedKeyId').textContent = newKey.key_id;
                document.getElementById('recreatedSecret').textContent = newKey.secret;
                document.getElementById('recreatedKeyModal').classList.add('show');

                // Reload access keys to show the new key
                await loadAccessKeys();
            } catch (err) {
                alert('Error recreating access key: ' + err.message);
            }
        }

        function hideRecreatedKeyModal() {
            document.getElementById('recreatedKeyModal').classList.remove('show');
            currentRecreatedKey = null;
        }

        function copyRecreatedKey() {
            if (!currentRecreatedKey) return;

            const text = `Key ID: ${currentRecreatedKey.key_id}\nSecret: ${currentRecreatedKey.secret}`;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Access key credentials copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('Access key credentials copied to clipboard!');
            } catch (err) {
                alert('Failed to copy. Please copy manually:\n\n' + text);
            }
            document.body.removeChild(textarea);
        }

        function escapeHtml(s) {
            if (!s) return '';
            return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
        }

        async function loadObjects() {
            currentBucket = getBucketName();
            if (!currentBucket) { window.location.href = '/ui/dashboard'; return; }
            document.getElementById('bucketTitle').textContent = 'Bucket: ' + currentBucket;
            const auth = getAuthHeader();
            if (!auth) return;
            try {
                const response = await fetch('/' + encodeURIComponent(currentBucket), { method: 'LIST', headers: { 'Authorization': auth } });
                if (response.status === 401) { logout(); return; }
                if (!response.ok) throw new Error('Failed to load objects');
                let objects = await response.json();
                // Normalize possible null / non-array responses to empty array
                if (!Array.isArray(objects)) {
                    // Some APIs might wrap in an object like {objects: [...]} - try to unwrap
                    if (objects && Array.isArray(objects.objects)) {
                        objects = objects.objects;
                    } else {
                        objects = [];
                    }
                }
                displayObjects(objects);
            } catch (err) {
                console.error('Error loading objects:', err);
                document.getElementById('loading').textContent = 'Error loading objects: ' + err.message;
            }
        }
        let objectTree = null;
        let folderOpenState = {}; // path -> bool

        function buildTree(objects) {
            // Defensive: ensure iterable
            if (!Array.isArray(objects)) objects = [];
            const root = { name: '', children: {}, object: null }; // object for leaf nodes
            for (const obj of objects) {
                const key = obj.object_key;
                const parts = key.split('/');
                let node = root;
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (!node.children[part]) {
                        node.children[part] = { name: part, children: {}, object: null, fullPath: parts.slice(0, i + 1).join('/') };
                        if (i < parts.length - 1) {
                            folderOpenState[node.children[part].fullPath] = folderOpenState[node.children[part].fullPath] ?? true;
                        }
                    }
                    node = node.children[part];
                    if (i === parts.length - 1) {
                        node.object = obj;
                    }
                }
            }
            return root;
        }

        function renderTree(root) {
            const tbody = document.getElementById('objectsBody');
            const table = document.getElementById('objectsTable');
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('emptyState');

            // If root has no children
            if (!root || Object.keys(root.children).length === 0) {
                loading.style.display = 'none';
                emptyState.style.display = 'block';
                table.style.display = 'none';
                // Bust image cache to encourage new random SVG (adds dummy query param)
                const img = document.getElementById('emptyStateImage');
                if (img) img.src = '/ui/empty.svg?rand=' + Date.now();
                return;
            }
            loading.style.display = 'none';
            emptyState.style.display = 'none';
            table.style.display = 'block';

            const rows = [];

            function walk(node, depth, parentOpen) {
                const isRoot = depth === 0 && node.name === '';
                // Sort folders then files alphabetically
                const entries = Object.values(node.children).sort((a,b)=>{
                    const aFolder = Object.keys(a.children).length > 0 || !a.object;
                    const bFolder = Object.keys(b.children).length > 0 || !b.object;
                    if (aFolder !== bFolder) return aFolder ? -1 : 1;
                    return a.name.localeCompare(b.name);
                });
                for (const child of entries) {
                    const childIsFolder = (Object.keys(child.children).length > 0 && (child.object == null || Object.keys(child.children).length > 0));
                    const path = child.fullPath;
                    const open = folderOpenState[path];
                    const visible = parentOpen; // ancestor must be open

                    if (childIsFolder) {
                        if (visible) {
                            const itemCount = countDescendantObjects(child);
                            rows.push(renderFolderRow(child.name, path, depth, open, itemCount));
                        }
                        // Recurse only if folder is open (to build rows for children that are visible)
                        walk(child, depth + 1, visible && open);
                    } else {
                        // Leaf object
                        if (visible) {
                            rows.push(renderObjectRow(child.object, depth));
                        }
                    }
                }
            }

            function countDescendantObjects(node) {
                let count = 0;
                function recurse(n) {
                    for (const k of Object.keys(n.children)) {
                        const c = n.children[k];
                        if (c.object) count++;
                        recurse(c);
                    }
                }
                recurse(node);
                return count;
            }

            function renderFolderRow(name, path, depth, open, itemCount) {
                const toggle = open ? '‚ñº' : '‚ñ∂';
                const indentPx = depth * 18;
                return `<tr class="folder-row" data-path="${escapeHtml(path)}" data-open="${open}" data-depth="${depth}">
                    <td style="padding-left:${indentPx}px"><span class="folder-toggle" onclick="toggleFolder('${escapeJs(path)}')">${toggle}</span> üìÅ <span class="folder-name">${escapeHtml(name)}</span><span class="folder-meta">(${itemCount} objects)</span></td>
                    <td colspan="4"></td>
                </tr>`;
            }

            function renderObjectRow(obj, depth) {
                const indentPx = depth * 18;
                const createdDate = new Date(obj.created_at * 1000).toLocaleString();
                const escapedKey = obj.object_key.replace(/'/g, "\\'");
                return `<tr class="object-row" data-key="${escapeHtml(obj.object_key)}" data-depth="${depth}">
                    <td style="padding-left:${indentPx}px">üìÑ <span class="object-name">${escapeHtml(obj.object_key.split('/').pop())}</span></td>
                    <td class="size">${formatBytes(obj.size)}</td>
                    <td>${obj.content_type || 'N/A'}</td>
                    <td>${createdDate}</td>
                    <td><div class="actions">
                        <button class="btn btn-copy btn-sm" onclick="copyObjectKey('${escapedKey}')" title="Copy full object key">üìã Copy Key</button>
                        <button class="btn btn-primary btn-sm" onclick="viewObject('${escapedKey}')">View</button>
                        <button class="btn btn-sm" onclick="downloadObject('${escapedKey}')">Download</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteObject('${escapedKey}')">Delete</button>
                    </div></td>
                </tr>`;
            }

            function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
            function escapeJs(s) { return s.replace(/['"\\]/g, c => '\\' + c); }

            // Walk starting from root (root is implicitly visible)
            walk(root, 0, true);
            tbody.innerHTML = rows.join('');
        }

        function toggleFolder(path) {
            folderOpenState[path] = !folderOpenState[path];
            renderTree(objectTree);
        }

        function displayObjects(objects) {
            // Build tree and render hierarchical view
            folderOpenState = folderOpenState || {}; // preserve existing open states across refreshes
            objectTree = buildTree(objects);
            renderTree(objectTree);
        }
        function toggleUploadMethod() {
            const method = document.querySelector('input[name="uploadMethod"]:checked').value;
            document.getElementById('fileUploadGroup').style.display = method === 'file' ? 'block' : 'none';
            document.getElementById('textUploadGroup').style.display = method === 'text' ? 'block' : 'none';
        }
        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const fileSelected = document.getElementById('fileSelected');
            const objectKeyInput = document.getElementById('objectKey');
            const contentTypeInput = document.getElementById('contentType');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileSelected.textContent = 'Selected: ' + file.name + ' (' + formatBytes(file.size) + ')';
                if (!objectKeyInput.value) objectKeyInput.value = file.name;
                if (!contentTypeInput.value && file.type) contentTypeInput.value = file.type;
            } else {
                fileSelected.textContent = '';
            }
        }
        function showUploadModal() {
            document.getElementById('uploadModal').classList.add('show');
            document.getElementById('objectKey').value = '';
            document.getElementById('contentType').value = '';
            document.getElementById('contentText').value = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('fileSelected').textContent = '';
            document.getElementById('objectKey').focus();
        }
        function hideUploadModal() { document.getElementById('uploadModal').classList.remove('show'); }
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const auth = getAuthHeader();
            if (!auth) return;
            const objectKey = document.getElementById('objectKey').value.trim();
            const contentType = document.getElementById('contentType').value.trim() || 'application/octet-stream';
            const method = document.querySelector('input[name="uploadMethod"]:checked').value;
            if (method === 'file') {
                const fileInput = document.getElementById('fileInput');
                if (!fileInput.files.length) { alert('Please select a file'); return; }
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const arrayBuffer = e.target.result;
                    const bytes = new Uint8Array(arrayBuffer);
                    let binary = '';
                    for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
                    await uploadObject(auth, objectKey, btoa(binary), contentType, true);
                };
                reader.readAsArrayBuffer(file);
            } else {
                // Encode text content as base64 to preserve special characters
                const text = document.getElementById('contentText').value;
                const contentB64 = base64EncodeText(text);
                await uploadObject(auth, objectKey, contentB64, contentType, true);
            }
        });
        async function uploadObject(auth, objectKey, content, contentType, base64Encoded) {
            try {
                const response = await fetch('/' + encodeURIComponent(currentBucket) + '/upload', {
                    method: 'POST',
                    headers: { 'Authorization': auth, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ object_key: objectKey, content: content, content_type: contentType, base64_encoded: base64Encoded })
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || 'Failed to upload object');
                }
                hideUploadModal();
                loadObjects();
            } catch (err) {
                alert('Error uploading object: ' + err.message);
            }
        }
        async function viewObject(objectKey) {
            const auth = getAuthHeader();
            if (!auth) return;
            try {
                const response = await fetch('/' + encodeURIComponent(currentBucket) + '/all/' + objectKey, {
                    method: 'GET',
                    headers: { 'Authorization': auth }
                });
                if (!response.ok) throw new Error('Failed to load object');
                const data = await response.json();
                currentViewObject = { key: objectKey, data: data };
                document.getElementById('viewObjectKey').textContent = objectKey;
                document.getElementById('viewContentType').textContent = data.object.content_type || 'N/A';
                document.getElementById('viewSize').textContent = formatBytes(data.object.size);
                try {
                    const bytes = base64ToBytes(data.content);
                    const isText = data.object.content_type && (data.object.content_type.startsWith('text/') || data.object.content_type.includes('json') || data.object.content_type.includes('xml'));
                    document.getElementById('viewContent').textContent = isText ? bytesToUtf8(bytes) : '[Binary content - ' + formatBytes(data.object.size) + ']\nUse Download to save the file.';
                } catch (err) {
                    document.getElementById('viewContent').textContent = '[Unable to preview content]';
                }
                document.getElementById('viewModal').classList.add('show');
            } catch (err) {
                alert('Error viewing object: ' + err.message);
            }
        }
        function hideViewModal() { document.getElementById('viewModal').classList.remove('show'); currentViewObject = null; }
        function downloadCurrentObject() { if (currentViewObject) downloadObject(currentViewObject.key); }
        async function downloadObject(objectKey) {
            const auth = getAuthHeader();
            if (!auth) return;
            try {
                const response = await fetch('/' + encodeURIComponent(currentBucket) + '/all/' + objectKey, {
                    method: 'GET',
                    headers: { 'Authorization': auth }
                });
                if (!response.ok) throw new Error('Failed to download object');
                const data = await response.json();
                const contentBytes = atob(data.content);
                const bytes = new Uint8Array(contentBytes.length);
                for (let i = 0; i < contentBytes.length; i++) bytes[i] = contentBytes.charCodeAt(i);
                const blob = new Blob([bytes], { type: data.object.content_type || 'application/octet-stream' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = objectKey.split('/').pop();
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (err) {
                alert('Error downloading object: ' + err.message);
            }
        }
        async function deleteObject(objectKey) {
            if (!confirm('Are you sure you want to delete "' + objectKey + '"?')) return;
            const auth = getAuthHeader();
            if (!auth) return;
            try {
                const response = await fetch('/' + encodeURIComponent(currentBucket) + '/' + objectKey, {
                    method: 'DELETE',
                    headers: { 'Authorization': auth }
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || 'Failed to delete object');
                }
                loadObjects();
            } catch (err) {
                alert('Error deleting object: ' + err.message);
            }
        }
        function copyObjectKey(objectKey) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(objectKey).then(() => {
                    // Show a temporary success message
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '‚úì Copied!';
                    btn.style.background = '#059669';
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    fallbackCopyKey(objectKey);
                });
            } else {
                fallbackCopyKey(objectKey);
            }
        }
        function fallbackCopyKey(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                alert('Object key copied to clipboard: ' + text);
            } catch (err) {
                alert('Failed to copy. Object key: ' + text);
            }
            document.body.removeChild(textarea);
        }
        function bindModalDismiss(modalEl, hideFn) {
            modalEl.addEventListener('click', function(e) {
                if (e.target === modalEl) hideFn();
            });
        }
        bindModalDismiss(document.getElementById('uploadModal'), hideUploadModal);
        bindModalDismiss(document.getElementById('viewModal'), hideViewModal);
        bindModalDismiss(document.getElementById('recreatedKeyModal'), hideRecreatedKeyModal);
        document.addEventListener('keydown', function(e) {
            if (e.key !== 'Escape') return;
            const viewOpen = document.getElementById('viewModal').classList.contains('show');
            const uploadOpen = document.getElementById('uploadModal').classList.contains('show');
            const recreatedOpen = document.getElementById('recreatedKeyModal').classList.contains('show');
            if (recreatedOpen) { hideRecreatedKeyModal(); return; }
            if (viewOpen) { hideViewModal(); return; }
            if (uploadOpen) { hideUploadModal(); return; }
        });
        loadObjects();

        // UTF-8 safe base64 encoder for text content
        function base64EncodeText(str) {
            if (window.TextEncoder) {
                const bytes = new TextEncoder().encode(str);
                let binary = '';
                for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
                return btoa(binary);
            }
            // Fallback for older browsers
            return btoa(unescape(encodeURIComponent(str)));
        }
        // Base64 to Uint8Array
        function base64ToBytes(b64) {
            const binary = atob(b64);
            const len = binary.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
            return bytes;
        }
        // Uint8Array to UTF-8 string
        function bytesToUtf8(bytes) {
            if (window.TextDecoder) {
                return new TextDecoder('utf-8', { fatal: false }).decode(bytes);
            }
            // Fallback
            let binary = '';
            for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
            return decodeURIComponent(escape(binary));
        }
    </script>
</body>
</html>
